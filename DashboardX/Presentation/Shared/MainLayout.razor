@using Infrastructure
@using Presentation.Utils

@using global::Shared.Constraints
@using global::Shared.Models.Users

@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject IStringLocalizer<MainLayout> _localizer
@inject AuthenticationStateProvider _authenticationStateProvider
@inject ILocalStorageService _localStorage
@inject IPrefrenceService _preferenceService

<MudLayout Class="p-0 m-0">
    <MudThemeProvider IsDarkMode="@IsDarkMode" @ref="_mudThemeProvider" Theme="@AppTheme" />
    <MudSnackbarProvider />
    <MudDialogProvider />

    <AuthorizeView Roles="@($"{RolesConstraints.User}, {RolesConstraints.Admin}")">
        <Authorized>
            <MudAppBar Elevation="1" Dense="@true" Color="Color.Primary">
                <MudIconButton Icon="@Icons.Material.Filled.Menu"
                               Color="Color.Secondary"
                               Edge="Edge.Start"
                               OnClick="@ToggleDrawer" />
                <MudSpacer />
            </MudAppBar>
            <MudDrawer @bind-Open="@Open"
                       ClipMode="DrawerClipMode.Docked"
                       Elevation="1"
                       Variant="@DrawerVariant.Responsive">

                <MudNavMenu Class="text-center">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudButton OnClick="NavigateToBrokers"
                                       Variant="Variant.Text"
                                       DisableRipple="true">
                                @_localizer["Brokers"]
                            </MudButton>
                        </MudItem>

                        <MudItem xs="12">
                            <MudButton OnClick="NavigateToDevices"
                                       Variant="Variant.Text"
                                       DisableRipple="true">
                                @_localizer["Devices"]
                            </MudButton>
                        </MudItem>

                        <MudItem xs="12">
                            <MudButton OnClick="NavigateToProfile"
                                       Variant="Variant.Text"
                                       DisableRipple="true">
                                @_localizer["Settings"]
                            </MudButton>
                        </MudItem>

                        <MudItem xs="12">
                            <AuthorizeView Roles="@RolesConstraints.Admin" Context="adminContext">
                                    <MudButton OnClick="NavigateToSubs"
                                           Variant="Variant.Text"
                                           DisableRipple="true">
                                    @_localizer["Subscribtions"]
                                    </MudButton>
                            </AuthorizeView>
                        </MudItem>

                        <MudItem xs="12">
                            <MudButton Variant="Variant.Text"
                                       OnClick="Logout">@_localizer["Logout"]</MudButton>
                        </MudItem>

                    </MudGrid>
                </MudNavMenu>
            </MudDrawer>

            @if (IsLoading)
            {
                <MudProgressLinear Color="Color.Tertiary"
                                   Indeterminate="@IsLoading"
                                   Size="Size.Medium"
                                   Class="progress-linear-under-appbar position-absolute" />
            }

            <MudMainContent Style="height: 100vh;">
                @Body
            </MudMainContent>
        </Authorized>
        <NotAuthorized>
            @if (IsLoading)
            {
                <MudProgressLinear Color="Color.Tertiary"
                                   Indeterminate="@IsLoading"
                                   Size="Size.Medium"
                                   Class="progress-linear position-absolute" />
            }

            <MudItem Class="image-in-background">
                <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-items-center bg-transparent" Style="height: 100vh;">
                    @Body
                </MudContainer>
            </MudItem>

        </NotAuthorized>
    </AuthorizeView>
</MudLayout>

@code {
    private bool Open { get; set; } = false;
    private bool IsLoading { get; set; } = false;
    private bool IsDarkMode { get; set; } = false;

    private MudTheme AppTheme { get; set; } = ThemeColors.AppTheme;
    private MudThemeProvider _mudThemeProvider = new();

    protected override async Task OnInitializedAsync()
    {
        base.OnInitialized();
        _loadingService.OnLoadingChanged = (isLoading) =>
        {
            IsLoading = isLoading;
            StateHasChanged();
            return Task.CompletedTask;
        };
        _preferenceService.OnPreferenceChange = async (preferences) =>
        {
            try
            {
                if (Theme.Inherit == preferences.Theme)
                {
                    var deviceMode = await _mudThemeProvider!.GetSystemPreference();
                    IsDarkMode = deviceMode;
                }
                else if (Theme.Light == preferences.Theme)
                    IsDarkMode = false;
                else
                    IsDarkMode = true;
            }
            catch
            {
                IsDarkMode = false;
            }
        };

        await _preferenceService.LoadPreferences();
        await _mudThemeProvider!.WatchSystemPreference(OnSystemPreferenceChanged);
    }

    private Task OnSystemPreferenceChanged(bool newValue)
    {
        IsDarkMode = newValue;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void ToggleDrawer()
    {
        Open = !Open;
    }

    #region Navigations

    public void NavigateToBrokers()
    {
        Open = false;
        _navigationManager.NavigateTo("/brokers");
    }

    public void NavigateToDevices()
    {
        Open = false;
        _navigationManager.NavigateTo("/devices");
    }

    public void NavigateToSubs()
    {
        Open = false;
        _navigationManager.NavigateTo("/user/settings");
    }

    public void NavigateToProfile()
    {
        Open = false;
        _navigationManager.NavigateTo("/subs");
    }

    private async Task Logout()
    {
        var applicationAuthorization = (_authenticationStateProvider as ApplicationStateProvider)!;

        await applicationAuthorization.Logout();
        await _localStorage.RemoveItemAsync(BrokerConstraints.BrokerListName);
        await _localStorage.RemoveItemAsync(DeviceConstants.DevicesListName);
        await _localStorage.RemoveItemAsync(UserConstraints.PreferencesStorage);
    }

    #endregion
}
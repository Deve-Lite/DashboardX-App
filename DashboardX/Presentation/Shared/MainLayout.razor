@using Infrastructure;
@using global::Shared.Constraints;
@inherits LayoutComponentBase
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject IStringLocalizer<MainLayout> _localizer
@inject AuthenticationStateProvider _authenticationStateProvider
@inject ILocalStorageService _localStorage

<MudLayout Class="p-0 m-0">
    <MudThemeProvider />
    <MudSnackbarProvider />
    <MudDialogProvider />

    <AuthorizeView Roles="@Roles">
        <Authorized>
            <MudAppBar Elevation="1" Style="height:50px" Dense="@true">
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
                <MudSpacer />
            </MudAppBar>
            <MudDrawer @bind-Open="@Open" ClipMode="DrawerClipMode.Docked" Elevation="1" Variant="@DrawerVariant.Responsive">
                <MudDrawerHeader>
                    <!-- TODO: Add icon here -->
                </MudDrawerHeader>
                <MudNavMenu>
                    <MudNavLink Match="NavLinkMatch.All" Href="/brokers">  @_localizer["Brokers"]  </MudNavLink>
                    <MudNavLink Match="NavLinkMatch.All" Href="/devices"> @_localizer["Devices"] </MudNavLink>
                    <MudNavLink Match="NavLinkMatch.All" Href="/user/settings"> @_localizer["Settings"] </MudNavLink>
                    <MudNavLink Match="NavLinkMatch.All" Href="/subs"> @_localizer["Subscribtions"] </MudNavLink>
                    <MudButton Variant="Variant.Text" OnClick="Logout">@_localizer["Logout"]</MudButton>
                </MudNavMenu>
            </MudDrawer>

            @if (IsLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="@IsLoading" Class="loading position-absolute" Style="margin-top: 50px" />
            }

            <MudMainContent Style="height: 100vh;">
                @Body
            </MudMainContent>
        </Authorized>
        <NotAuthorized>
            @if (IsLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="@IsLoading" Class="loading position-absolute" />
            }
            <MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-items-center" Style="height: 100vh;">
                @Body
            </MudContainer>
        </NotAuthorized>
    </AuthorizeView>
</MudLayout>

@code {
    private bool Open { get; set; } = false;
    private bool IsLoading { get; set; } = false;

    private string Roles { get; set; } = $"{RolesConstraints.Admin}, {RolesConstraints.User}";

    protected override void OnInitialized()
    {
        base.OnInitialized();
        _loadingService.OnLoadingChanged = (isLoading) =>
        {
            IsLoading = isLoading;
            StateHasChanged();
            return Task.CompletedTask;
        };
    }

    private async Task Logout()
    {
        var applicationAuthorization = (_authenticationStateProvider as ApplicationStateProvider)!;

        await applicationAuthorization.Logout();
        await _localStorage.RemoveItemAsync(BrokerConstraints.BrokerListName);
        await _localStorage.RemoveItemAsync(DeviceConstants.DevicesListName);
        await _localStorage.RemoveItemAsync(UserConstraints.UserStorage);
    }

    private void ToggleDrawer()
    {
        Open = !Open;
    }
}
@using Presentation.Utils;
@inject IStringLocalizer<ConfirmDialog> _localizer
@inject IUserService _userService

@inherits BaseFormDialog

<MudDialog>
    <DialogContent>
        <DialogLoading IsLoading="IsLoading">
            <LoadedContent>
                <MudForm @ref="@Form"
                         Model="@Model"
                         Validation="@(Validator.ValidateValue)"
                         ValidationDelay="0">
                    <MudGrid Class="p-0 m-0 w-100">
                        <MudItem xs="12">

                            <PasswordTextField @bind-Value="Model.Password"
                                               For="@(() => Model.Password)"
                                               Label="@_localizer["Password"]"
                                               HelperText="@_localizer["Provide actual password for your account."]" />
                        </MudItem>
                        <MudItem xs="12">
                            <PasswordTextField @bind-Value="Model.NewPassword"
                                               For="@(() => Model.NewPassword)"
                                               Label="@_localizer["Password"]"
                                               HelperText="@_localizer["Provide actual password for your account."]" />

                        </MudItem>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="Model.ConfirmNewPassword"
                                          T="string"
                                          For="@(() => Model.ConfirmNewPassword)"
                                          Variant="Variant.Filled"
                                          Clearable="true"
                                          InputType="InputType.Password"
                                          Label="@_localizer["Confirm New Password"]"
                                          HelperText="@_localizer["Please repeat password."]" />
                        </MudItem>
                    </MudGrid>
                </MudForm>
            </LoadedContent>
        </DialogLoading>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel"
                   Disabled="IsLoading">
            @_localizer["Cancel"]
        </MudButton>
        <MudButton OnClick="ChangeAsync"
                   Disabled="IsLoading"
                   Variant="Variant.Filled"
                   Color="Color.Primary">
            @_localizer["Change"]
        </MudButton>
    </DialogActions>
</MudDialog>

@code
{
    private ChangePasswordModel Model = new();
    private ChangePasswordValidator Validator = new();

    private async Task ChangeAsync()
    {
        if (IsLoading)
            return;

        await Form!.Validate();

        if (!Form.IsValid)
            return;

        IsLoading = true;
        StateHasChanged();

        var result = await _userService.ChangePassword(Model);

        var success = RequestHelpers.InvokeAfterRequest(_snackbar, result, _localizer["Successfully changed password!"]);

        IsLoading = false;

        if (!success)
            return;

        Dialog!.Close(DialogResult.Ok(result));
    }
}
